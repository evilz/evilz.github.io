<!DOCTYPE html>
<html ⚡ lang="en">
  <head>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Lora:400,700' rel='stylesheet' type='text/css'>
  <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
  <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
  <script async custom-element="amp-gist" src="https://cdn.ampproject.org/v0/amp-gist-0.1.js"></script>
  <script async custom-element="amp-install-serviceworker" src="https://cdn.ampproject.org/v0/amp-install-serviceworker-0.1.js"></script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">
  <meta name="theme-color" content="#ffffff">

  <title>Cecil.Decompiler Part 1 - Language Writer</title>
  <meta name="description" content="Introduction">

  <link rel="canonical" href="https://www.evilznet.com/2009/02/09/cecil-decompiler-part-1-language-writer/">
  <link rel="alternate" type="application/rss+xml" title="Evilz blog" href="https://www.evilznet.com/feed.xml">
  <link rel="manifest" href="/manifest.json">

  <script type="application/ld+json">
  
{
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": "https://www.evilznet.com/2009/02/09/cecil-decompiler-part-1-language-writer/",
  "headline": "Cecil.Decompiler Part 1 - Language Writer",
  "datePublished": "2009-02-09T09:29:00+00:00",
  "dateModified": "2009-02-09T09:29:00+00:00",
  "description": "Introduction",
  "author": {
    "@type": "Person",
    "name": "Vincent Bourdon"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Evilz blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.evilznet.com/assets/images/logo.jpg",
      "width": "60",
      "height": "60"
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "https://www.evilznet.com/assets/images/logo.jpg",
    "height": "60",
    "width": "60"
  }
}

  </script>

  <style amp-custom>
  
  /**
 * Syntax highlighting styles
 */
.highlight {
  background: #fff;
  /* Comment */
  /* Error */
  /* Keyword */
  /* Operator */
  /* Comment.Multiline */
  /* Comment.Preproc */
  /* Comment.Single */
  /* Comment.Special */
  /* Generic.Deleted */
  /* Generic.Emph */
  /* Generic.Error */
  /* Generic.Heading */
  /* Generic.Inserted */
  /* Generic.Output */
  /* Generic.Prompt */
  /* Generic.Strong */
  /* Generic.Subheading */
  /* Generic.Traceback */
  /* Keyword.Constant */
  /* Keyword.Declaration */
  /* Keyword.Namespace */
  /* Keyword.Pseudo */
  /* Keyword.Reserved */
  /* Keyword.Type */
  /* Literal.Number */
  /* Literal.String */
  /* Name.Attribute */
  /* Name.Builtin */
  /* Name.Class */
  /* Name.Constant */
  /* Name.Decorator */
  /* Name.Entity */
  /* Name.Exception */
  /* Name.Function */
  /* Name.Label */
  /* Name.Namespace */
  /* Name.Tag */
  /* Name.Variable */
  /* Operator.Word */
  /* Text.Whitespace */
  /* Literal.Number.Float */
  /* Literal.Number.Hex */
  /* Literal.Number.Integer */
  /* Literal.Number.Oct */
  /* Literal.String.Backtick */
  /* Literal.String.Char */
  /* Literal.String.Doc */
  /* Literal.String.Double */
  /* Literal.String.Escape */
  /* Literal.String.Heredoc */
  /* Literal.String.Interpol */
  /* Literal.String.Other */
  /* Literal.String.Regex */
  /* Literal.String.Single */
  /* Literal.String.Symbol */
  /* Name.Builtin.Pseudo */
  /* Name.Variable.Class */
  /* Name.Variable.Global */
  /* Name.Variable.Instance */
  /* Literal.Number.Integer.Long */ }
  .highlighter-rouge .highlight {
    background: #fcfcfc; }
  .highlight pre {
    background-color: #fcfcfc; }
  .highlight code {
    background-color: #fcfcfc; }
  .highlight .hll {
    background-color: #ffffcc; }
  .highlight .c {
    color: #999988;
    font-style: italic; }
  .highlight .err {
    color: #a61717;
    background-color: #e3d2d2; }
  .highlight .k {
    color: #000000;
    font-weight: bold; }
  .highlight .o {
    color: #000000;
    font-weight: bold; }
  .highlight .cm {
    color: #999988;
    font-style: italic; }
  .highlight .cp {
    color: #999999;
    font-weight: bold;
    font-style: italic; }
  .highlight .c1 {
    color: #999988;
    font-style: italic; }
  .highlight .cs {
    color: #999999;
    font-weight: bold;
    font-style: italic; }
  .highlight .gd {
    color: #000000;
    background-color: #ffdddd; }
  .highlight .ge {
    color: #000000;
    font-style: italic; }
  .highlight .gr {
    color: #aa0000; }
  .highlight .gh {
    color: #999999; }
  .highlight .gi {
    color: #000000;
    background-color: #ddffdd; }
  .highlight .go {
    color: #888888; }
  .highlight .gp {
    color: #555555; }
  .highlight .gs {
    font-weight: bold; }
  .highlight .gu {
    color: #aaaaaa; }
  .highlight .gt {
    color: #aa0000; }
  .highlight .kc {
    color: #000000;
    font-weight: bold; }
  .highlight .kd {
    color: #000000;
    font-weight: bold; }
  .highlight .kn {
    color: #000000;
    font-weight: bold; }
  .highlight .kp {
    color: #000000;
    font-weight: bold; }
  .highlight .kr {
    color: #000000;
    font-weight: bold; }
  .highlight .kt {
    color: #445588;
    font-weight: bold; }
  .highlight .m {
    color: #009999; }
  .highlight .s {
    color: #d01040; }
  .highlight .na {
    color: #008080; }
  .highlight .nb {
    color: #0086B3; }
  .highlight .nc {
    color: #445588;
    font-weight: bold; }
  .highlight .no {
    color: #008080; }
  .highlight .nd {
    color: #3c5d5d;
    font-weight: bold; }
  .highlight .ni {
    color: #800080; }
  .highlight .ne {
    color: #990000;
    font-weight: bold; }
  .highlight .nf {
    color: #990000;
    font-weight: bold; }
  .highlight .nl {
    color: #990000;
    font-weight: bold; }
  .highlight .nn {
    color: #555555; }
  .highlight .nt {
    color: #000080; }
  .highlight .nv {
    color: #008080; }
  .highlight .ow {
    color: #000000;
    font-weight: bold; }
  .highlight .w {
    color: #bbbbbb; }
  .highlight .mf {
    color: #009999; }
  .highlight .mh {
    color: #009999; }
  .highlight .mi {
    color: #009999; }
  .highlight .mo {
    color: #009999; }
  .highlight .sb {
    color: #d01040; }
  .highlight .sc {
    color: #d01040; }
  .highlight .sd {
    color: #d01040; }
  .highlight .s2 {
    color: #d01040; }
  .highlight .se {
    color: #d01040; }
  .highlight .sh {
    color: #d01040; }
  .highlight .si {
    color: #d01040; }
  .highlight .sx {
    color: #d01040; }
  .highlight .sr {
    color: #009926; }
  .highlight .s1 {
    color: #d01040; }
  .highlight .ss {
    color: #990073; }
  .highlight .bp {
    color: #999999; }
  .highlight .vc {
    color: #008080; }
  .highlight .vg {
    color: #008080; }
  .highlight .vi {
    color: #008080; }
  .highlight .il {
    color: #009999; }

/* Basscss Margin */
.m0 {
  margin: 0; }

.mt0 {
  margin-top: 0; }

.mr0 {
  margin-right: 0; }

.mb0 {
  margin-bottom: 0; }

.ml0 {
  margin-left: 0; }

.mx0 {
  margin-left: 0;
  margin-right: 0; }

.my0 {
  margin-top: 0;
  margin-bottom: 0; }

.m1 {
  margin: 0.5rem; }

.mt1 {
  margin-top: 0.5rem; }

.mr1 {
  margin-right: 0.5rem; }

.mb1 {
  margin-bottom: 0.5rem; }

.ml1 {
  margin-left: 0.5rem; }

.mx1 {
  margin-left: 0.5rem;
  margin-right: 0.5rem; }

.my1 {
  margin-top: 0.5rem;
  margin-bottom: 0.5rem; }

.m2 {
  margin: 1rem; }

.mt2 {
  margin-top: 1rem; }

.mr2 {
  margin-right: 1rem; }

.mb2 {
  margin-bottom: 1rem; }

.ml2 {
  margin-left: 1rem; }

.mx2 {
  margin-left: 1rem;
  margin-right: 1rem; }

.my2 {
  margin-top: 1rem;
  margin-bottom: 1rem; }

.m3 {
  margin: 2rem; }

.mt3 {
  margin-top: 2rem; }

.mr3 {
  margin-right: 2rem; }

.mb3 {
  margin-bottom: 2rem; }

.ml3 {
  margin-left: 2rem; }

.mx3 {
  margin-left: 2rem;
  margin-right: 2rem; }

.my3 {
  margin-top: 2rem;
  margin-bottom: 2rem; }

.m4 {
  margin: 4rem; }

.mt4 {
  margin-top: 4rem; }

.mr4 {
  margin-right: 4rem; }

.mb4 {
  margin-bottom: 4rem; }

.ml4 {
  margin-left: 4rem; }

.mx4 {
  margin-left: 4rem;
  margin-right: 4rem; }

.my4 {
  margin-top: 4rem;
  margin-bottom: 4rem; }

.mxn1 {
  margin-left: -0.5rem;
  margin-right: -0.5rem; }

.mxn2 {
  margin-left: -1rem;
  margin-right: -1rem; }

.mxn3 {
  margin-left: -2rem;
  margin-right: -2rem; }

.mxn4 {
  margin-left: -4rem;
  margin-right: -4rem; }

.ml-auto {
  margin-left: auto; }

.mr-auto {
  margin-right: auto; }

.mx-auto {
  margin-left: auto;
  margin-right: auto; }

.icon > svg {
  display: inline-block;
  width: 16px;
  height: 16px;
  vertical-align: middle; }
  .icon > svg path {
    fill: #828282; }

.fixed-container {
  position: relative;
  max-width: 700px;
  height: 180px; }

.fixed-header {
  position: relative;
  max-width: 700px;
  height: 360px; }

.fixed-footer {
  position: relative;
  max-width: 300px;
  height: 80px; }

amp-img {
  background-color: #fff; }

amp-img.contain img {
  object-fit: contain; }

amp-img.cover img {
  object-fit: cover; }

.cf:after {
  content: "";
  display: table;
  clear: both; }

main {
  display: block; }

body {
  background-color: #fff;
  font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 0;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-font-feature-settings: "liga=1, dlig=1";
  -ms-font-feature-settings: "liga", "dlig";
  -webkit-font-feature-settings: "liga", "dlig";
  -o-font-feature-settings: "liga", "dlig";
  font-feature-settings: "liga", "dlig"; }

.site-header {
  position: relative;
  width: 100%;
  max-width: 700px;
  margin: 16px auto 0 auto;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box; }
  @media only screen and (max-width: 800px) {
    .site-header {
      padding: 0 16px; } }
  .site-header .page-links {
    display: block;
    position: absolute;
    top: 10px;
    right: 16px;
    font-weight: 200;
    font-style: normal;
    font-size: 18px;
    line-height: 30px; }
    .site-header .page-links a {
      text-decoration: none;
      color: #999999; }
      .site-header .page-links a:hover {
        color: #333333; }

.blog-header {
  width: 100%;
  max-width: 700px;
  margin: 0 auto;
  position: relative;
  padding: 0;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box; }
  .blog-header .blog-title {
    margin-bottom: 8px;
    font-size: 50px;
    font-weight: 700;
    letter-spacing: -2px;
    outline: 0;
    line-height: 50px;
    word-break: break-word;
    color: #333333; }
  .blog-header .blog-description {
    font-size: 28px;
    margin: 0 0 20px;
    padding: 0;
    line-height: 1.2;
    color: #666666;
    font-weight: 300; }

.content {
  width: 100%;
  max-width: 700px;
  margin: 25px auto 0 auto;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box; }
  @media only screen and (max-width: 800px) {
    .content {
      padding: 0 16px; } }
  .content article {
    padding: 20px 0;
    border-bottom: 1px solid #f2f2f0; }
    .content article:last-child {
      border-bottom: 0px; }
    .content article .post-title {
      letter-spacing: -0.02em;
      font-weight: 700;
      font-style: normal;
      display: block;
      font-size: 36px;
      line-height: 1.15;
      margin: 0 0; }
      .content article .post-title a {
        text-decoration: none;
        color: #333332; }
        .content article .post-title a:hover {
          text-decoration: none; }
    .content article .post-excerpt {
      letter-spacing: -0.02em;
      font-weight: 300;
      font-style: normal;
      font-size: 20px;
      line-height: 1.59;
      color: #666665; }
    .content article .post-meta {
      font-size: 14px;
      color: #b3b3b1;
      line-height: 30px; }
      .content article .post-meta a {
        color: #b3b3b1;
        text-decoration: none; }
        .content article .post-meta a:hover {
          text-decoration: underline; }

.post-template .content {
  max-width: 700px; }

.index-headline {
  border-top: 1px solid #dededc;
  margin: 0;
  padding: 16px 0; }
  .index-headline span {
    color: #b3b3b1;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px; }

.pagination {
  text-align: center;
  padding: 16px 0 0;
  font-size: 12px; }
  .pagination a {
    color: #999999;
    text-decoration: none; }
    .pagination a:hover {
      color: #333333; }

.site-footer {
  margin: 0 auto;
  padding: 48px 0;
  width: 100%;
  max-width: 700px;
  font-size: 12px;
  text-align: center;
  color: #999999;
  line-height: 17.6px; }
  .site-footer a {
    color: #666666;
    text-decoration: none; }
    .site-footer a:hover {
      color: #333333; }

.post .post-meta {
  font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-title {
  font-weight: 700;
  font-style: normal;
  letter-spacing: -0.04em;
  font-size: 50px;
  line-height: 1.1;
  color: #333332;
  margin-bottom: 50px; }
.post .author-image {
  background-image: url(/assets/images/logo.jpg);
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  margin-right: 8px;
  margin-bottom: -10px;
  float: left;
  background-size: cover;
  border-radius: 100%;
  text-indent: -9999px; }
.post .post-meta-text {
  color: #b3b3b1;
  letter-spacing: -0.02em;
  font-weight: 400;
  font-style: normal;
  font-size: 14px;
  overflow: hidden;
  font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif;
  white-space: nowrap;
  text-overflow: ellipsis; }
.post .post-content {
  width: 100%;
  font-family: Georgia, Cambria, "Times New Roman", Times, "Lora", serif;
  color: #333333; }
  .post .post-content h1, .post .post-content h2, .post .post-content h3 {
    font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
  .post .post-content h3, .post .post-content h4, .post .post-content h5, .post .post-content h6 {
    letter-spacing: -0.02em;
    font-weight: 700;
    font-style: normal;
    font-size: 24px;
    line-height: 1.3;
    margin-top: 50px;
    margin-bottom: 0px;
    font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
  .post .post-content h3 {
    font-size: 36px; }
  .post .post-content h2, .post .post-content h1 {
    letter-spacing: -0.02em;
    font-weight: 700;
    font-style: normal;
    font-size: 42px;
    line-height: 1.2;
    margin-top: 50px;
    margin-bottom: 0px; }
  .post .post-content table {
    border-collapse: collapse; }
  .post .post-content table, .post .post-content th, .post .post-content td {
    border: 1px solid black;
    padding: 5px;
    text-align: left; }
  .post .post-content p {
    font-weight: 400;
    font-style: normal;
    font-size: 21px;
    line-height: 1.59;
    letter-spacing: -.002em;
    margin-top: 30px;
    margin-bottom: 0;
    color: #333333;
    -webkit-hyphens: auto;
    -moz-hyphens: auto;
    hyphens: auto; }
  .post .post-content a {
    color: #333333;
    text-decoration: underline; }
  .post .post-content amp-img, .post .post-content amp-youtube {
    margin-top: 30px; }
  .post .post-content figure {
    margin: 0;
    padding: 0 0 30px; }
  .post .post-content figcaption {
    font-weight: 400;
    font-style: italic;
    font-size: 16px;
    line-height: 1.3;
    color: #666665;
    outline: 0;
    z-index: 300;
    text-align: center; }
  .post .post-content hr {
    border: 0;
    padding: 0;
    display: block;
    width: 15%;
    margin: 30px auto;
    border: 0px solid #dddddd;
    border-top: 1px solid #dddddd; }
  .post .post-content blockquote {
    margin: 0 0 30px;
    margin-left: -26px;
    border-left: 3px solid #57ad68;
    padding-left: 20px; }
    .post .post-content blockquote p {
      letter-spacing: 0.01rem;
      font-weight: 400;
      mborder-left: 3px solid #57ad68;
      mpadding-left: 20px;
      mmargin-left: -26px;
      padding-bottom: 3px; }
  .post .post-content ul, .post .post-content ol {
    padding: 0 0 30px;
    margin: 0; }
  .post .post-content li {
    padding: 0;
    font-weight: 400;
    font-style: normal;
    font-size: 23px;
    line-height: 30px;
    margin-left: 30px;
    margin-bottom: 12px;
    padding-top: 2px; }
    .post .post-content li p {
      padding: 0 0 1.618rem; }
  .post .post-content ol li {
    list-style-type: decimal; }
.post .bottom-teaser {
  padding: 50px 0 0 0;
  font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
  .post .bottom-teaser hr {
    border: 0;
    padding: 0;
    display: block;
    width: 15%;
    margin: 16px 0 16px 100px;
    border: 0px solid #dddddd;
    border-top: 1px solid #dddddd; }
  .post .bottom-teaser .isLeft {
    float: left;
    width: 47%;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box; }
    @media only screen and (max-width: 800px) {
      .post .bottom-teaser .isLeft {
        width: 100%;
        padding-bottom: 32px; } }
    .post .bottom-teaser .isLeft .bio {
      margin-top: 18px;
      margin-bottom: 18px; }
    .post .bottom-teaser .isLeft .username {
      margin-left: 4px;
      margin-right: 18px;
      margin-bottom: 18px; }
    .post .bottom-teaser .isLeft .index-headline {
      padding-bottom: 32px; }
    .post .bottom-teaser .isLeft a {
      color: black;
      text-decoration: none; }
      .post .bottom-teaser .isLeft a:hover {
        color: #333333;
        text-decoration: underline; }
    .post .bottom-teaser .isLeft .author-image {
      display: block;
      width: 80px;
      height: 80px;
      float: left;
      background-size: cover;
      border-radius: 100%;
      text-indent: -9999px; }
    .post .bottom-teaser .isLeft h4 {
      font-size: 18px;
      line-height: 1.1;
      font-weight: 700;
      padding: 0;
      margin: 0;
      padding-left: 100px; }
    .post .bottom-teaser .isLeft p {
      font-size: 14px;
      line-height: 1.3;
      font-weight: 400;
      padding: 0;
      margin: 0;
      padding-left: 100px; }
      .post .bottom-teaser .isLeft p.published {
        color: #999999; }
  .post .bottom-teaser .isRight {
    float: right;
    width: 47%;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box; }
    @media only screen and (max-width: 800px) {
      .post .bottom-teaser .isRight {
        width: 100%; } }
    .post .bottom-teaser .isRight .index-headline {
      padding-bottom: 32px; }
    .post .bottom-teaser .isRight .site-footer {
      margin: 0;
      padding: 0;
      color: #333333;
      text-align: left;
      font-size: 14px;
      line-height: 1.3;
      color: #999999; }
      .post .bottom-teaser .isRight .site-footer a {
        color: #333333;
        text-decoration: none; }
        .post .bottom-teaser .isRight .site-footer a:hover {
          text-decoration: underline; }
      .post .bottom-teaser .isRight .site-footer .poweredby {
        display: block;
        padding-bottom: 18px;
        font-weight: 700;
        color: #333333; }

.share {
  text-align: right;
  padding: 20px 0 0; }
  .share a {
    text-decoration: none;
    color: #bbbbbb;
    padding-left: 12px; }
    .share a .hidden {
      display: none; }
    .share a:hover {
      color: #333333; }

pre,
code {
  font-size: 15px;
  border: 1px solid #e8e8e8;
  border-radius: 3px;
  background-color: #fcfcfc;
  color: #000000; }

code {
  padding: 1px 5px; }

pre {
  padding: 8px 12px;
  overflow-x: auto; }
  pre > code {
    border: 0;
    padding-right: 0;
    padding-left: 0; }

.pagination .disabled {
  opacity: 0; }

  </style>

  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
  <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

  <body>
    <header class="site-header">
  <a href="/" class="logo"><span class="logo"><amp-img src="/assets/images/logo.jpg" width="48" height="48" alt="evilz logo" /></span></a>

  <div class="page-links">
    <a class="page-link" href="/">Home</a>
    
      
      • <a class="page-link" href="/_slides/Intro-Fable/">Introduction a FABLE</a>
      
    
      
      • <a class="page-link" href="/about/">About</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  </div>
</header>


    <div class="feature"></div>
<main class="content" role="main">
  <article class="post">
    <div class="post-meta">
      <h1 class="post-title">Cecil.Decompiler Part 1 - Language Writer</h1>
    </div>

 
    <section class="post-content">
      <a name="topofpage"></a>

        <!-- Post Feature Image -->
   

   <h1 id="introduction">Introduction</h1>

<p>Cet article va vous faire découvrir le projet Cecil.Decompiler sur lequel j’ai commencé à travailler au Code Camp de décembre 2008. Je vous invite à lire les posts suivants, pour en savoir plus sur ce fameux code camp.</p>

<p>http://evilznet.com/post/Evilznet-apres-un-CodeCamp.aspx
http://www.evain.net/blog/articles/2008/12/16/decompiler-codecamp
http://codingly.com/2008/12/16/cecildecompiler-un-decompilateur-net-opensource
http://patricelamarche.net/2009/01/03/CecilDecompilerDecompilateurNetOpenSourceBaséSurCecil.aspx</p>

<p>Nous allons voir le namespace <code class="highlighter-rouge">Cecil.Decompiler.Languages</code> et plus particulièrement le LanguageWriter.
C’est sur cette partie que j’ai travaillé durant le Code Camp avec Patrice Lamarche pour la décompilation du langage VB. Mes explications seront basées sur les classes de base que l’ont trouves dans le core de <code class="highlighter-rouge">Cecil.Decompiler</code> et qui ont été écrites par Jb Evain.</p>

<h1 id="définition-dun-langage">Définition d’un langage</h1>

<p><amp-img src="https://farm5.staticflickr.com/4595/39372522761_d64f6709c2_z.jpg" alt="language" width="640" height="583" layout="responsive"><noscript><img src="https://farm5.staticflickr.com/4595/39372522761_d64f6709c2_z.jpg" alt="language" width="640" height="583"></noscript></amp-img></p>

<p>Tous les langages utilisés dans <code class="highlighter-rouge">Cecil.Decompiler</code> doivent implémenter l’interface <code class="highlighter-rouge">ILanguage</code>.
Un langage est défini par un nom (propriété <code class="highlighter-rouge">Name</code>) et deux méthodes :</p>

<ul>
  <li>
<code class="highlighter-rouge">CreatePipeline()</code> qui renvoie un nouveau <code class="highlighter-rouge">DecompilationPipeline</code>, c’est-à-dire une suite d’opérations qui s’applique sur le contexte de décompilation pour transformer son résultat. (Nous aborderons ce point dans un futur article ;))</li>
  <li>
<code class="highlighter-rouge">GetWriter()</code> qui renvoie un <code class="highlighter-rouge">ILanguageWriter</code> (c’est le cœur de notre sujet)</li>
</ul>

<p>Pour C#, la classe qui implémente l’interface s’appelle <code class="highlighter-rouge">CSharp</code>. Cette classe est directement utilisable, mais pour de futures optimisations en fonction des évolutions du langage, plusieurs classes enfants ont été créés <code class="highlighter-rouge">CSharpV1</code>, <code class="highlighter-rouge">CSharpV2</code>, <code class="highlighter-rouge">CSharpV3</code>. Actuellement ces quatre classes sont identiques sauf pour la propriété Name qui retourne une valeur différente.
Une énumération <code class="highlighter-rouge">CSharpVersion</code> est aussi présente pour lister ces différentes implémentations, cela pourra servir pour afficher très simplement toutes ces versions dans une liste déroulante de notre GUI.</p>

<h1 id="la-sortie--iformater">La sortie : IFormater</h1>

<p>Le formater va définir comment seront ajouté les résultats de la décompilation dans le flux de sortie. On peut imaginer toute sorte de formater Html, XML, SilverLight …
IFormater spécifie 12 méthodes qui devront exister dans les formaters concrets.</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">void</span> <span class="nf">Write</span> <span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">WriteLine</span> <span class="p">();</span>  
<span class="k">void</span> <span class="nf">WriteSpace</span> <span class="p">();</span>  
<span class="k">void</span> <span class="nf">WriteToken</span> <span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">WriteComment</span> <span class="p">(</span><span class="kt">string</span> <span class="n">comment</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">WriteKeyword</span> <span class="p">(</span><span class="kt">string</span> <span class="n">keyword</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">WriteLiteral</span> <span class="p">(</span><span class="kt">string</span> <span class="n">literal</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">WriteDefinition</span> <span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">definition</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">WriteReference</span> <span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">reference</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">WriteIdentifier</span> <span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">identifier</span><span class="p">);</span>  
<span class="k">void</span> <span class="nf">Indent</span> <span class="p">();</span>  
<span class="k">void</span> <span class="nf">Outdent</span> <span class="p">();</span>
</code></pre>
  </div>
</div>

<p>Le Core de <code class="highlighter-rouge">Cecil.decompiler</code> fournie une classe concrète <code class="highlighter-rouge">PlainTextFormater</code>.
Comme son nom l’indique c’est le formater le plus basic, il va simplement écrire le résultat sous forme de texte dans le flux désiré : une console, un fichier …
Nous allons voir comment implémenter très simplement une sortie dans une console avec de la couleur.
Pour commencer, je vais créer un nouveau projet de type librairie en C# (3.5) que je vais appeler <code class="highlighter-rouge">ColoredConsoleFormater</code>. Il faut ensuite ajouter la référence vers <code class="highlighter-rouge">Cecil.Decompiler</code>.</p>

<p><amp-img src="https://farm5.staticflickr.com/4594/39372522991_84cac5d3a7.jpg" alt="project" width="241" height="134" layout="responsive"><noscript><img src="https://farm5.staticflickr.com/4594/39372522991_84cac5d3a7.jpg" alt="project" width="241" height="134"></noscript></amp-img></p>

<p>Je renomme ou créé une classe <code class="highlighter-rouge">ColoredConsoleFormater.cs</code> qui va implémenter <code class="highlighter-rouge">IFormater</code></p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Cecil.Decompiler.Languages</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ColoredConsoleFormater</span> <span class="p">:</span> <span class="n">IFormatter</span>
    <span class="p">{</span>
        <span class="err">#</span><span class="n">region</span> <span class="n">IFormatter</span> <span class="n">Members</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Write</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteLine</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteSpace</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteComment</span><span class="p">(</span><span class="kt">string</span> <span class="n">comment</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>
 
        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteKeyword</span><span class="p">(</span><span class="kt">string</span> <span class="n">keyword</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteLiteral</span><span class="p">(</span><span class="kt">string</span> <span class="n">literal</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>
 
        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteDefinition</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">definition</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>
 
        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteReference</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">reference</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteIdentifier</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>
 
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Indent</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Outdent</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>
 
        <span class="err">#</span><span class="n">endregion</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p>L’idée est ici, de faire écrire chacune de ces méthodes dans une couleur différente. Par exemple les mots clés en bleu, les commentaires en vert …</p>

<p>Il y a 8 méthodes qui écrivent du texte, je vais donc ajouter 8 constantes de type ConsoleColor en affectant différentes couleurs de mon choix.</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">NormalColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Gray</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">TokenColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">White</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">CommentColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Green</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">KeywordColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">LiteralColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Red</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">DefinitionColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Cyan</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">ReferenceColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Yellow</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="n">ConsoleColor</span> <span class="n">IdentifierColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Magenta</span><span class="p">;</span>
</code></pre>
  </div>
</div>

<p>Il faut maintenant écrire dans la console en utilisant ces couleurs. Je commence par implémenter la méthode <code class="highlighter-rouge">Write(string str)</code> qui va simplement écrire la chaine passée en argument dans la console. Les autres méthodes pourront alors spécifier la couleur dans laquelle le texte doit être écrit, puis appeler cette méthode.</p>

<p>Apres l’appel, il ne faut pas oublier de remettre la console dans la couleur de base.</p>

<p>La méthode <code class="highlighter-rouge">WriteLine()</code> est un cas particulier, je fais ici appelle directement à la méthode <code class="highlighter-rouge">WriteLine()</code> de la console, cela garantie un bon retour à la ligne qui peut être représenté différemment en fonction des systèmes.</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">Write</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteLine</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteSpace</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="s">" "</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">TokenColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteComment</span><span class="p">(</span><span class="kt">string</span> <span class="n">comment</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">CommentColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="n">comment</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteKeyword</span><span class="p">(</span><span class="kt">string</span> <span class="n">keyword</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">KeywordColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="n">keyword</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteLiteral</span><span class="p">(</span><span class="kt">string</span> <span class="n">literal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">LiteralColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="n">literal</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteDefinition</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">definition</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">DefinitionColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteReference</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">reference</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ReferenceColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteIdentifier</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">object</span> <span class="n">identifier</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">IdentifierColor</span><span class="p">;</span>
    <span class="nf">Write</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p><amp-img src="https://farm5.staticflickr.com/4726/25503576108_e644361b7c_z.jpg" alt="console1" width="640" height="321" layout="responsive"><noscript><img src="https://farm5.staticflickr.com/4726/25503576108_e644361b7c_z.jpg" alt="console1" width="640" height="321"></noscript></amp-img></p>

<p>Il reste maintenant à afficher correctement l’indentation du code en implémentant <code class="highlighter-rouge">Indent()</code> et <code class="highlighter-rouge">Outdent()</code>.
Pour cela nous allons utiliser un compteur qui stocke le nombre de tabulation courante. <code class="highlighter-rouge">Indent()</code> va alors incrémenter cette valeur et <code class="highlighter-rouge">Outdent()</code> la décrémenter.
Pour écrire les indentations nous créons une nouvelle méthode <code class="highlighter-rouge">WriteIndent()</code>, elle sera appelée par la méthode <code class="highlighter-rouge">Write()</code>. Les indentations ne devront pas être écrites plusieurs fois par ligne, il faut donc utiliser une variable de type bool pour indiquer si <code class="highlighter-rouge">WriteIndent()</code> doit être appelée ou non. La méthode <code class="highlighter-rouge">WriteLine()</code> affectera sa valeur à true alors que <code class="highlighter-rouge">Write()</code> l’affectera à false.</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="kt">int</span> <span class="n">indent</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">write_indent</span><span class="p">;</span>

<span class="k">void</span> <span class="nf">WriteIndent</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">write_indent</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">indent</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"\t"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Write</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">WriteIndent</span><span class="p">();</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="n">write_indent</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">public</span> <span class="k">void</span> <span class="nf">WriteLine</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
    <span class="n">write_indent</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Indent</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">indent</span><span class="p">++;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Outdent</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">indent</span><span class="p">--;</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p>Il ne reste plus qu’à rajouter un constructeur par défaut qui va initialiser la couleur de la console avec la couleur de base (NormalColor)</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">public</span> <span class="nf">ColoredConsoleFormater</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">NormalColor</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p><amp-img src="https://farm5.staticflickr.com/4690/25503575998_06cdd2367c_z.jpg" alt="console2" width="640" height="321" layout="responsive"><noscript><img src="https://farm5.staticflickr.com/4690/25503575998_06cdd2367c_z.jpg" alt="console2" width="640" height="321"></noscript></amp-img></p>

<p>Vous vous demandez surement pourquoi les méthodes <code class="highlighter-rouge">WriteDefinition()</code>, <code class="highlighter-rouge">WriteReference()</code>, <code class="highlighter-rouge">WriteIdentifier()</code> prennent un argument supplémentaire qui n’est pas utilisé ici. Ce second argument pourra, par exemple, être utilisé dans notre GUI pour faire un lien lorsque l’utilisateur va cliquer sur la chaine ou même pourvoir ajouter différentes fonctionnalités en fonction de son type.</p>

<h1 id="le-writer">Le writer</h1>

<p>Le writer est la classe qui va définir la syntaxe du langage, il ne faut pas confondre avec le formater qui lui définit la sortie, c’est à dire le flux final.</p>

<p>Comme nous l’avons vu au dessus le writer est renvoyé par le langage et implémente l’interface ILanguageWriter.</p>

<p>L’implémentation nécessite l’écriture des différentes surcharges de la méthode Write(). Cette méthode sera le point d’entrée du Writer. En fonction de l’argument qui sera passé, par exemple la définition d’un type, d’une méthode ou simplement une expression, elle écrira le résultat de la décompilation correspondante dans le formater.</p>

<p>Avant d’implémenter directement l’interface, l’on va passer par une classe intermédiaire BaseLanguageWriter qui contient quelques méthodes facilement réutilisable dans tous les writer concrets, et un constructeur prenant en paramètre un Ilangage et un IFormater.</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">public</span> <span class="nf">BaseLanguageWriter</span> <span class="p">(</span><span class="n">ILanguage</span> <span class="n">language</span><span class="p">,</span> <span class="n">IFormatter</span> <span class="n">formatter</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteToken</span> <span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteSpace</span> <span class="p">();</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteLine</span> <span class="p">();</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteKeyword</span> <span class="p">(</span><span class="kt">string</span> <span class="n">keyword</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">Write</span> <span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteLiteral</span> <span class="p">(</span><span class="kt">string</span> <span class="n">literal</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteIdentifier</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">object</span> <span class="n">identifier</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteDefinition</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">object</span> <span class="n">definition</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">WriteReference</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">object</span> <span class="n">reference</span><span class="p">);</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">Indent</span> <span class="p">();</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">Outdent</span> <span class="p">();</span>
</code></pre>
  </div>
</div>

<p>Vous l’aurez sans doute deviné, toutes ces méthodes sont des raccourcis vers les méthodes équivalentes du IFormater que l’on à vu juste avant. De plus cette classe hérite d’une autre classe BaseCodeVisitor fournie avec l’AST de Cecil.Decompiler.</p>

<p>Passons maintenant à notre classe concrète que l’on appellera CSharpWriter. Nous n’allons pas voir en détail tout l’implémentation, pour cela vous pouvez télécharger les sources sur le SVN. Je vais plutôt vous expliquer le fonctionnement.</p>

<p>Après la décompilation, chaque petite partie de code est représentée dans un graphe d’objet (AST) par des nœuds de type ICodeNode. A partir de là, on peut donc facilement implémenter un pattern, que certain reconnaitront (car c’est le même pour Linq et ses expressions), à base d’une grosse méthode Visit() qui prend en argument un ICodeNode.</p>

<p>Cette méthode, qui se trouve dans la classe BaseCodeVisitor, va tout simplement lire le type réel de l’ICodeNode pour appeler une méthode plus spécifique. Ce n’est en fait qu’un gros switch.</p>

<p>Voici un exemple pour un bout de code pour un Statement. La méthode Write() est appelée :</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Write</span> <span class="p">(</span><span class="n">Statement</span> <span class="n">statement</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">Visit</span> <span class="p">(</span><span class="n">statement</span><span class="p">);</span>
    <span class="nf">WriteLine</span> <span class="p">();</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p>On va alors visiter le contenu du statement. Je vais ici prendre pour exemple un statement de type if/else, je vous laisse le loisir de regarder tous les types différents de ICodeNode existants.
Le switch va identifier le type de nœud par rapport à la valeur de sa propriété CodeNodeType qui contient une valeur de l’énumération CodeNodeType :</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">public</span> <span class="k">enum</span> <span class="n">CodeNodeType</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">IfStatement</span><span class="p">,</span>
    <span class="n">BinaryExpression</span><span class="p">,</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="c1">// Methode de BaseCodeVisitor</span>
<span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Visit</span> <span class="p">(</span><span class="n">ICodeNode</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="p">==</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
 
    <span class="k">switch</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">CodeNodeType</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// … différents case</span>
    <span class="k">case</span> <span class="n">CodeNodeType</span><span class="p">.</span><span class="n">IfStatement</span><span class="p">:</span>
        <span class="nf">VisitIfStatement</span> <span class="p">((</span><span class="n">IfStatement</span><span class="p">)</span> <span class="n">node</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="c1">// … différents case</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span> <span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p>On peut voir qu’une méthode spécifique pour ce genre de statement est à son tour appelée : VisitIfStatement() qui prend simplement le node courant casté.</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">VisitIfStatement</span> <span class="p">(</span><span class="n">IfStatement</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">WriteKeyword</span> <span class="p">(</span><span class="s">"if"</span><span class="p">);</span>
    <span class="nf">WriteSpace</span> <span class="p">();</span>
    <span class="nf">WriteBetweenParenthesis</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Condition</span><span class="p">);</span>
    <span class="nf">WriteLine</span> <span class="p">();</span>
 
    <span class="nf">Visit</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Then</span><span class="p">);</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Else</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
 
    <span class="nf">WriteKeyword</span> <span class="p">(</span><span class="s">"else"</span><span class="p">);</span>
    <span class="nf">WriteLine</span> <span class="p">();</span>
    <span class="nf">Visit</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Else</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p>Cette méthode écrit enfin dans le flux de sortie. C’est du C#, donc on commence par écrire le mot clé if, on ajoute un espace pour la présentation (optionnel). Il faut ensuite écrire le contenu de la condition entre parenthèse, cela est fait via la méthode WriteBetweenParenthesis() qui écrit la parenthèse ouvrante, visite l’expression de la condition et écrit la parenthèse fermante.</p>

<div class="language-csharp highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><span class="k">void</span> <span class="nf">WriteBetweenParenthesis</span> <span class="p">(</span><span class="n">Expression</span> <span class="n">expression</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">WriteToken</span> <span class="p">(</span><span class="s">"("</span><span class="p">);</span>
    <span class="nf">Visit</span> <span class="p">(</span><span class="n">expression</span><span class="p">);</span>
    <span class="nf">WriteToken</span> <span class="p">(</span><span class="s">")"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
  </div>
</div>

<p>Et voilà on parcourt le graph de façon récursive !
Visit() va resélectionner la bonne méthode à appeler en fonction du type de l’expression et ainsi de suite jusqu’au bout de l’arbre.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Nous avons vue comment implémenter un langage comme C#. Il faut cependant savoir que le graph d’objet ne correspond par forcément toujours aux attentes du langage cible, il est donc nécessaire de faire des manipulations en amont sur le graph via le fameux pipeline. Actuellement deux langages sont traités par l’équipe, il s’agit C# et VB. Ne tient qu’à vous d’implémenter un autre langage .net.</p>

    </section>

    <footer class="post-footer">
      <section class="share">
        <a class="icon" href="https://twitter.com/intent/tweet?url=https://www.evilznet.com/2009/02/09/cecil-decompiler-part-1-language-writer&text=Cecil.Decompiler+Part+1+-+Language+Writer&via=Evilznet" target="_blank">
          Share on
          <svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>

        </a>

        <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> RSS feed.</span></a>
      </section>
    </footer>
    <div class="bottom-teaser cf">
      <div class="isLeft">
        <h5 class="index-headline featured"><span>Written by</span></h5>
        <section class="author">
          <div class="author-image"></div>
          <h4>Vincent Bourdon</h4>
          <p class="bio">.Net Dev since 2001
</p>

          <p>
            <span>
              
                
<span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><a href="https://github.com/evilz"><span class="username">evilz</span></a>


              
            </span>

            <span>
              
                
<span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><a href="https://twitter.com/Evilznet"><span class="username">Evilznet</span></a>


              
            </span>
          </p>
          <hr>
          <p class="published">Published <time datetime="2009-02-09 09:29">09 Feb 2009</time></p>
        </section>
      </div>
      <div class="isRight">
          <h5 class="index-headline featured"><span>A lire aussi</span></h5>

          <footer class="site-footer">
              <section class="poweredby">
                
 <!-- Pagination links -->
 <div class="PageNavigation">
    
      <a class="prev" href="/2009/01/22/ma-premiere-reunion-alt-net/">&laquo; Ma première réunion Alt.net</a>
      

      
    
    
    
      <a class="next" href="/2009/02/19/alt-net-fr-10-aspectize/">Alt.net FR &raquo;</a>
        

      
    
  </div>

              </section>
             
             
            
            </footer>

       

        
      </div>
    </div>
  </article>
</main>

    
    <amp-analytics type="googleanalytics" id="amp-analytics">
<script type="application/json">
{
  "vars": {
    "account": "UA-2063306-2"
  },
  "triggers": {
    "trackPageview": {
      "on": "visible",
      "request": "pageview"
    }
  }
}
</script>
</amp-analytics>


<amp-install-serviceworker
    src="/serviceworker.js"
    layout="nodisplay">
</amp-install-serviceworker>    

<amp-gist
data-gistid="ccabc534e91280364fcbe9b775a551a9"
data-file="empty"
layout="fixed-height"
height="0">
</amp-gist>

  </body>
</html>
